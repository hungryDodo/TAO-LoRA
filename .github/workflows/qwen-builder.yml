name: ğŸ”¨ Qwen Builder
on:
  schedule:
    - cron: '*/15 * * * *' # æ¯15åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  issues:
    types: [labeled]

jobs:
  build:
    if: contains(github.event.issue.labels.*.name, 'qwen-build') || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
          pip install numpy scipy triton pytest

      - name: Find Task
        id: find_task
        run: |
          # æŸ¥æ‰¾å¸¦æœ‰ 'qwen-build' æ ‡ç­¾ä¸”æœªåˆ†é…çš„ Issue
          # è¾“å‡º Issue Number å’Œç›¸å…³ Spec æ–‡ä»¶è·¯å¾„
          ISSUE_NUMBER=$(gh issue list --label "qwen-build" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ ! -z "$ISSUE_NUMBER" ] && [ "$ISSUE_NUMBER" != "null" ]; then
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

            # å°è¯•æ‰¾åˆ°ç›¸å…³çš„ spec æ–‡ä»¶
            SPEC_PATH=$(find specs/ -name "*.md" -exec grep -l "#$ISSUE_NUMBER" {} \; | head -1)
            if [ -z "$SPEC_PATH" ]; then
              SPEC_PATH=$(find specs/ -name "spec.md" | head -1)
            fi
            if [ ! -z "$SPEC_PATH" ]; then
              echo "spec_path=$SPEC_PATH" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Builder Agent
        if: steps.find_task.outputs.issue_number != ''
        uses: qwenlm/qwen-code-action@v1
        with:
          qwen-token: ${{ secrets.QWEN_TOKEN }}
          model: 'qwen-2.5-coder-32b-instruct'
          task: "implement"
          prompt: |
            ä½ æ˜¯é«˜çº§å¼€å‘å·¥ç¨‹å¸ˆã€‚
            ç›®æ ‡ï¼šè§£å†³ Issue #${{ steps.find_task.outputs.issue_number }}
            ä¾æ®ï¼šè¯·ä¸¥æ ¼éµå¾ª Spec æ–‡æ¡£ ${{ steps.find_task.outputs.spec_path }}

            éµå¾ª TAO-LoRA é¡¹ç›®è§„èŒƒï¼š
            - ç¬¦åˆ `.specify/memory/constitution.md` ä¸­çš„é¡¹ç›®åŸåˆ™
            - å®ç°æ—¶é—´æ„ŸçŸ¥é‡åŒ–ã€åŠ¨æ€è·¯å¾„è·¯ç”±ã€ç¡¬ä»¶ä¼˜åŒ–å’Œäº‹ä»¶ä¿ç•™æœºåˆ¶
            - éµå¾ªå·²æœ‰çš„é¡¹ç›®ç»“æ„å’Œä»£ç é£æ ¼

            æ‰§è¡Œæ­¥éª¤ï¼š
            1. æ£€æŸ¥ `specs/${{ steps.find_task.outputs.issue_number }}-*` ç›®å½•ä¸‹çš„ specã€plan å’Œ tasks æ–‡ä»¶ï¼Œäº†è§£å…·ä½“è¦æ±‚ã€‚
            2. æ ¹æ® `tasks.md` ä¸­çš„ä»»åŠ¡åˆ—è¡¨é€æ­¥å®ç°åŠŸèƒ½ã€‚
            3. **å¿…é¡»**ç¼–å†™å¯¹åº”çš„å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿ä»£ç è´¨é‡ã€‚
            4. è¿è¡Œæµ‹è¯•ï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ©ç”¨å‰©ä½™é¢åº¦è‡ªåŠ¨ä¿®å¤ä»£ç ï¼ˆSelf-Healingï¼‰ã€‚
            5. æäº¤ PRï¼Œåˆ†æ”¯åä¸º `feat/issue-${{ steps.find_task.outputs.issue_number }}`ã€‚
            6. åœ¨ PR æè¿°ä¸­å¼•ç”¨ç›¸å…³ Issue (#${{ steps.find_task.outputs.issue_number }})ã€‚
