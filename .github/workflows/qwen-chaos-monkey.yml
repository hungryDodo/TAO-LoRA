name: 🐵 Qwen Chaos Monkey (Optimizer)
on:
  schedule:
    - cron: '*/30 * * * *' # 每30分钟运行一次

jobs:
  chaos_optimize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Identify Weak Targets
        id: target
        run: |
          # 这里可以使用简单的脚本或工具分析代码库
          # 策略1：随机抽取一个修改时间超过 7 天的文件
          # 策略2：查找代码行数超过 200 行且没有对应 .test.ts 的文件
          # 策略3：利用 grep 查找 "TODO" 或 "FIXME"
          echo "target_file=src/legacy_module.py" >> $GITHUB_OUTPUT

      - name: Chaos Agent
        uses: qwenlm/qwen-code-action@v1
        with:
          qwen-token: ${{ secrets.QWEN_TOKEN }}
          model: 'qwen-2.5-coder-32b-instruct'
          task: "refactor"
          prompt: |
            你是 "Chaos Monkey" 代码进化者。你的目标是主动提升代码库的鲁棒性。

            目标文件：${{ steps.target.outputs.target_file }}

            请执行以下任一操作（根据文件情况决定）：
            1. **补充测试**：如果该文件没有测试，请为它编写全面的单元测试。
            2. **类型强化**：如果代码中有 `any` (TS) 或缺少类型注解 (Python)，请补全强类型。
            3. **性能优化**：如果发现低效的循环或逻辑，进行重构。
            4. **文档补全**：如果缺少 DocString，请补全。

            规则：
            - 先创建一个 Spec：`specs/optimization/opt-${{ steps.target.outputs.target_file }}.md` 描述你要做的事情。
            - 代码必须通过现有的 CI 检查。
            - 提交 PR，标题前缀必须是 `[CHAOS]`，并打上 `auto-optimization` 标签。
